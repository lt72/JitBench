# 1. ETWLogAnalyzer Documentation

<!-- TOC -->

- [1. ETWLogAnalyzer Documentation](#1-etwloganalyzer-documentation)
    - [1.1. Purpose of the tool](#11-purpose-of-the-tool)
    - [1.2. Architecture and Extensibility](#12-architecture-and-extensibility)
        - [1.2.1. Data Storage - the model](#121-data-storage---the-model)
        - [1.2.2. The Controller](#122-the-controller)
        - [1.2.3. ReportsVisitors](#123-reportsvisitors)
        - [1.2.4. Reports](#124-reports)
    - [1.3. How to use the tool with the sample app](#13-how-to-use-the-tool-with-the-sample-app)
    - [1.4. Provided Implementations](#14-provided-implementations)
        - [1.4.1. Model - _ETWData_](#141-model---_etwdata_)
        - [1.4.2. Visitors](#142-visitors)
        - [1.4.3. Reports](#143-reports)
        - [1.4.4. Defined Metrics](#144-defined-metrics)
    - [1.5. Relevant documentation for TraceEvents when generating your own reports](#15-relevant-documentation-for-traceevents-when-generating-your-own-reports)

<!-- /TOC -->

## 1.1. Purpose of the tool

ETWLogAnalyzer is an extensible framework that simplifies the analysis of the impact of modifications to the jitting pipeline based off ETW logs collected from running applications.

## 1.2. Architecture and Extensibility

### 1.2.1. Data Storage - the model

The model that stores the data gathered from the ETW log must implement the [IEventModel](..\ETWLogAnalyzer\Microsoft.ETWLogAnalyzer.Abstractions\Abstractions\Model\IEventModel.cs) interface. The idea is that the model provides at least these:

- Information of the process being examined (pid,  start and stop events, etc...).
- List of the methods jitted and the threads used by the process.
- API calls to get the events for a given thread and the thread that JITs a method.

A concrete example of the model is [ETWData](..\ETWLogAnalyzer\Microsoft.ETWLogAnalyzer.Core\ETWData\ETWData.cs).

### 1.2.2. The Controller

The [controller](..\ETWLogAnalyzer\Microsoft.ETWLogAnalyzer.Core\Controller\Controller.cs) is the component of the framework that manages who has access to the data model and how they can access it as follows.

- `RunVisitorForResult` - Reports will have to use a visitor to analyze the data provided by the model. This method will take the visitor and an iterator to the stream of events that need to be analyzed and run it for the result.
- `ProcessReports` - Given the folder of the assemblies where the reports are and the data to analyze, the controller will generate them and dump them into the specified folder.
- Serialization/Deserialization of the model will be supported in the future.

### 1.2.3. ReportsVisitors

_Report visitors_ are the basic blocks that reports will use to perform analysis on the data. The convenient part is they are small objects of their own so they can store state that's usually needed for event series analysis (e.g a specific type of event sequence that seems to be a performance bottleneck). This might have to happen at the cost of multiple passes, but adds to the extensibility of the analysis tool which is our main focus.

All visitors extend the generic class [EventVisitorBase](..\ETWLogAnalyzer\Microsoft.ETWLogAnalyzer.Abstractions\Abstractions\ReportVisitors\EventVisitorBase.cs), with the generic paraameter being the type of result expected from the calculation. Within the base class:

- `State` is a property that should be updated to `VisitorState.Error` if any problem is encountered and the report should handle accordingly, or set to `VisitorState.Done` so the controller can escape early from the iterating through the events.
- `Visit` should implement the logic of the analysis
- `AddRelevantTypes` - Most events that wil be found might not be relevant for a type of analysis. The controller will use the types added to restrict the events that use the `Visit` method only to the types added as relevant.
- `IsRelevant` - Method the controller uses to determine if an event is relevant before visiting it. Doesn't need to be overriden if the filtering is performed using the filtering by type as described in `AddRelevantTypes`, otherwise must be implemented.
- `Result` is a property of the type of the generic parameter of the visitor and caches the result of the calculation. It's only valid if `State` is not `VisitorState.Error`

An example of this is [PerceivedJitTimeVisitor](..\ETWLogAnalyzer\Microsoft.ETWLogAnalyzer.Reports\ReportVisitors\PerceivedJitTimeVisitor.cs).

### 1.2.4. Reports

All reports generated by the framework implement the [IReport](..\ETWLogAnalyzer\Microsoft.ETWLogAnalyzer.Abstractions\Abstractions\Reports\IReport.cs) interface. All it provides is the name of the report and two stub methods:

- `Analyze` is the method where reports should create visitors to the data model that's passed in and cache the results in any convenient format.
- `Persist` is the method where the cached analyzed data should be persisted in whatever manner the developer feels meets their purpose.

## 1.3. How to use the tool with the sample app

To run the sample app open an Visual Studio developer console with Admin privileges and navigate to the [scripts](../Scripts/) folder.

- First you need to run the [data collection script](../Scripts/collect_etw_data.cmd). This will compile the JitBench app using a freshly downloaded version .NET core and collect the ETW log. There isn't any need to modify the script unless you want to modify what events get collected. The script also supports disabling superfetch to collect a cold start by running is with the `clean` argument (e.g. `collect_etw_data.cmd clean`).
- Second run the [data analysis script](../Scripts/analyze_etw_data.cmd). You should modify the `OUT_DIR` variable script to point to the folder you want to store the reports to. You can modify the `WAIT` variable to false if you don't want the tool to wait for user input at the end as well.

## 1.4. Provided Implementations

### 1.4.1. Model - _ETWData_

### 1.4.2. Visitors

- `AvailableQuantumAccumulatorVisitor`
- `JitTimeAccumulatorVisitor`
- `GetFirstMatchingEventVisitor`
- `PerceivedJitTimeVisitor`

### 1.4.3. Reports

- `JitStatistics`
- `LifetimeStatistics`
- `ThreadStatistics`

### 1.4.4. Defined Metrics

## 1.5. Relevant documentation for TraceEvents when generating your own reports

The documents and release notes can be found in the [TraceEvent documentation](TraceEventDocs/) folder